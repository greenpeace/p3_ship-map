/** greenpeace-ship-map - 2014-03-24 */
!function(a,b,c,d){"use strict";var e,f={api:{url:"../test/json/test-cloudmade.json"},options:{debug:!0,showEdgeMarkers:!0},behaviour:{keyboard:{eventNavigation:!0},point:{centerOnOpen:!0}},map:{minZoom:2,maxZoom:10,locations:{center:{coords:[-42,147],zoom:6}},tileSet:{url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",apiKey:!1,retinaUrl:!1,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'}},selectors:{mapContainer:"#shipping-map .map-container",map:"#map",menu:{header:".map-header",trigger:".menu-trigger",container:".map-header nav",ship:".map-menu .ships ul",feature:".map-menu .features ul"},templates:{menu:{ship:"#shipMenuTemplate",feature:"#featureMenuTemplate"},popup:{feature:"#featurePopupTemplate"}}},breakpoint:{oldmobile:320,handheld:768,tablet:980,laptop:1200,desktop:2e4},style:{point:{"default":{radius:8,fillColor:"white",color:"black",weight:8,opacity:1,fillOpacity:.8}},icon:{"default":"fa-dot-circle-o",events:{"noon-update":"circle","ship-event":"dot-circle-o","featured-event":"certificate"},ship:{iconUrl:"img/icons/rainbow-warrior_100.png",shadowUrl:"",iconSize:[100,100],shadowSize:[0,0],iconAnchor:[50,80],shadowAnchor:[0,0],popupAnchor:[-3,0]}},path:{"default":{offset:0,repeat:"6px",pixelSize:2,pathOptions:{color:"#fff",weight:2}},future:{offset:0,repeat:"6px",pixelSize:2,pathOptions:{color:"#ccc",weight:2}}}}},g=a(d),h=function(a){var b=Math.floor((new Date-new Date(a))/1e3/60);return 1440>b?"today":b>=1440&&2880>b?"yesterday":b>=2880&&10080>b?Math.floor(b/60/24)+" days ago":b>=10080&&20160>b?"a week ago":b>=20160&&80640>b?Math.floor(b/60/24/7)+" weeks ago":Math.floor(b/60/24/7/4)+" months ago"},i=function(a,c,d){var e={};return e.pathStyle="undefined"!=typeof c.path[a.properties.period.identifier]?c.path[a.properties.period.identifier]:c.path.default,e.pathStyle.className=d,e.offset=e.pathStyle.offset,e.repeat=e.pathStyle.repeat,e.symbol=new b.Symbol.Dash(e.pathStyle),e};g.ready(function(){var c={menu:{ship:{},feature:{}},popup:{feature:{}}},d={},j={data:{types:[]},groups:{all:{}}};a.getJSON(f.api.url,function(k){function l(a,b){return a.popups[b]&&a.popups[b].openPopup()._map}function m(b){var c=a(".ship-popup"),e=d[parseInt(c.attr("data-ship-id"),10)],f=c.attr("data-ship-event-index"),g=e.popups.length;switch(b){case"prev":for(;f>=0&&!l(e,--f););break;case"next":for(;g>f&&!l(e,++f););}}function n(b){isNaN(b)||a(".ship-icon").each(function(){var c=a(this);a.each(["width","height","margin-left","margin-top"],function(a,d){c.data(d)||c.data(d,c.css(d).replace("px","")),c.css(d,c.data(d)*b*b)}),t.data("iconScale",b)})}var o=a.extend(!0,f,k),p=a(o.selectors.mapContainer),q=a(o.selectors.menu.ship),r=a(o.selectors.menu.feature),s=b.map(o.selectors.map.replace("#",""),{keyboard:o.behaviour.keyboard.eventNavigation?!1:!0}).setView(o.map.locations.center.coords,o.map.locations.center.zoom),t=a(o.selectors.map);a("html").addClass("zoom-"+o.map.locations.center.zoom),c.menu.ship=a.templates(o.selectors.templates.menu.ship),c.menu.feature=a.templates(o.selectors.templates.menu.feature),c.popup.feature=a.templates(o.selectors.templates.popup.feature),b.tileLayer(o.map.tileSet.url,{attribution:o.map.tileSet.attribution,apiKey:o.map.tileSet.apiKey,minZoom:o.map.minZoom,maxZoom:o.map.maxZoom}).addTo(s),a.each(o.ships,function(e,f){var g=f.geojson.features.length,k={},l={data:{features:{types:[],all:[]},paths:{periods:[],all:[]},all:[]},groups:{all:{},features:{},paths:{}}},m=[],n=a.extend(!0,a.extend(!0,{},o.style),f.style);a.each(f.geojson.features,function(d,e){var i,o,p={identifier:makeSafeForCSS(e.properties.type.identifier),name:e.properties.type.name,icon:""};o="string"==typeof e.properties.type.icon?e.properties.type.icon:"undefined"!=typeof n.icon.events[e.properties.type.identifier]?n.icon.events[e.properties.type.identifier]:n.icon.default,p.icon=o,i=b.geoJson(e,{style:n.point.default,pointToLayer:function(a,c){var h=!1,i="undefined"!=typeof n.point[e.properties.type.identifier]?n.point[e.properties.type.identifier]:n.point.default;return g-1>d?(k=c,h=b.SimpleMarkers.icon({icon:o,iconColor:i.color})):(e.properties.edgeMarker=n.icon.menu,k.lng&&k.lng<c.lng&&(n.icon.ship.iconUrl=n.icon.ship.iconUrl.replace("_100.","_100_right.")),n.icon.ship.className="ship-icon "+f.nameSimple,h=b.icon(n.icon.ship)),e.properties.icon=h,b.marker(c,{icon:h})},onEachFeature:function(a,b){m[d]=b.bindPopup(c.popup.feature.render({index:d,ship:f,shipIcon:n.icon.menu.iconUrl,extraClasses:a.properties.image?"image":!1,feature:a.properties,humanTime:h(a.properties.timestamp),next:g-1>d?d+1:!1,prev:d>0?d-1:!1}),{maxWidth:600})}}).addTo(s),a.grep(l.data.features.types,function(a){return a.identifier===p.identifier}).length<1&&(l.data.features.types.push(p),l.data.features[p.identifier]=[],a.grep(j.data.types,function(a){return a.identifier===p.identifier}).length<1&&(j.data.types.push(p),j.data[p.identifier]=[])),l.data.all.push(i),g-1>d&&j.data[p.identifier].push(i)}),a.each(f.geojson.paths,function(c,d){var e,g=[];a.each(d.coordinates,function(a,b){g.push([b[1],b[0]])}),e=b.polylineDecorator(b.polyline(g),{patterns:[i(d,n,"ship-"+f.id)]}),l.data.all.push(e)}),l.groups.all=b.layerGroup(l.data.all),s.addLayer(l.groups.all),d[f.id]={layers:l,popups:m,name:f.name,nameSimple:f.nameSimple,id:f.id,style:n},q.append(c.menu.ship.render({name:f.name,simpleName:f.nameSimple,icon:n.icon.menu.iconUrl,id:f.id})),console.log(" <=== End "+f.name)}),t.data("ships",d),a.each(j.data.types,function(a,d){r.append(c.menu.feature.render({name:d.name,type:d.identifier,icon:d.icon})),j.groups[d.identifier]=b.layerGroup(j.data[d.identifier]).addTo(s)}),g.on("click",".map-menu .ships button",function(b){var c=a(this),e=c.attr("data-ship-id");e?(b.preventDefault(),console.log("Toggle all "+c.parent().attr("class")+" layers"),c.toggleClass("hideLayer").hasClass("hideLayer")?s.removeLayer(d[e].layers.groups.all):(s.addLayer(d[e].layers.groups.all),a.each(j.data.types,function(b,c){a('button[data-feature-type="'+c.identifier+'"]').hasClass("hideLayer")&&s.addLayer(j.groups[c.identifier]).removeLayer(j.groups[c.identifier])}),s.fire("shiptoggle"))):c.hasClass("toggleMenu")?c.toggleClass("closed").next().toggleClass("close"):console.warn("Unhandled")}),g.on("click",".map-menu .features button",function(b){var c=a(this),d=c.attr("data-feature-type");d?(b.preventDefault(),c.toggleClass("hideLayer").hasClass("hideLayer")?s.removeLayer(j.groups[d]):s.addLayer(j.groups[d])):c.hasClass("toggleMenu")?c.next().toggleClass("close"):console.warn("Unhandled")}),g.on("click",".ship-popup button",function(){m(a(this).attr("data-direction"))}),o.behaviour.keyboard.eventNavigation&&g.keydown(function(a){(37===a.which||39===a.which)&&(a.preventDefault(),m(37===a.which?"prev":"next"))}),o.behaviour.point.centerOnOpen&&s.on("popupopen",function(a){var c=s.options.crs.latLngToPoint(a.popup._latlng,a.popup._map._zoom);s.panTo(s.options.crs.pointToLatLng(b.point(c.x,c.y-150),a.popup._map._zoom))}),s.on("zoomstart zoomend load resize shiptoggle",function(a){var b,c=o.map.locations.center.zoom;switch(a.type){case"load":case"resize":b=a.target._zoom/c;break;case"zoomstart":case"zoomend":b=a.target._animateToZoom/c;break;case"shiptoggle":b=t.data("iconScale");break;default:b=1}t.data("iconScale",b),n(b)}),o.options.showEdgeMarkers&&b.edgeMarker({radius:50,fillColor:"white"}).addTo(s),o.options.debug,setTimeout(function(){p.addClass("show")},1e3);var u=jRespond([{label:"oldmobile",enter:0,exit:o.breakpoint.oldmobile-1},{label:"handheld",enter:o.breakpoint.oldmobile,exit:o.breakpoint.handheld-1},{label:"tablet",enter:o.breakpoint.handheld,exit:o.breakpoint.tablet-1},{label:"laptop",enter:o.breakpoint.tablet,exit:o.breakpoint.laptop-1},{label:"desktop",enter:o.breakpoint.laptop,exit:o.breakpoint.desktop}]);e=a.jPanelMenu({menu:o.selectors.menu.container,trigger:o.selectors.menu.trigger,direction:"right",closeOnContentClick:!1,keyboardShortcuts:!1,openPosition:o.breakpoint.oldmobile+"px",beforeOpen:function(){a(".jPanelMenu-panel").addClass("narrow")},afterOpen:function(){a(o.selectors.menu.trigger).addClass("active"),s.invalidateSize()},beforeClose:function(){a(".jPanelMenu-panel").removeClass("narrow")},afterClose:function(){a(o.selectors.menu.trigger).removeClass("active"),s.invalidateSize()}}),e.on(),u.addFunc([{breakpoint:["handheld"],enter:function(){a("body").addClass("handheld"),e.close()},exit:function(){}},{breakpoint:["laptop","desktop"],enter:function(){e.open()},exit:function(){}}])}).fail(function(a){console.error("Error fetching "+f.api.url,a)})})}(jQuery,L,this,document);